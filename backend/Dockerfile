# --- –ë–∞–∑–æ–≤–∏–π –æ–±—Ä–∞–∑ Python 3.10 ---
FROM python:3.10

# --- –†–æ–±–æ—á–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—è ---
WORKDIR /app

# --- –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø–µ—Ä–µ–¥ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è–º ---
RUN echo "üöÄ –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫–æ—Å–º—ñ—á–Ω–æ–≥–æ –∫–æ—Ä–∞–±–ª—è..."

# --- –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–∏—Å—Ç–µ–º–∏ —ñ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–æ—Ç—Ä—ñ–±–Ω–∏—Ö –ø–∞–∫–µ—Ç—ñ–≤ ---
RUN apt-get update && apt-get install -y --no-install-recommends \
    git \
    build-essential \
    wget \
    curl \
    libatlas-base-dev \
    gfortran \
    pkg-config \
    ca-certificates \
    locales \
    python3-dev \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# --- –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—ñ—Å–ª—è —Å–∏—Å—Ç–µ–º–Ω–∏—Ö –ø–∞–∫–µ—Ç—ñ–≤ ---
RUN echo "üî≠ –ó–∞–≤–∞–Ω—Ç–∞–∂—É—é –µ—Ñ–µ–º–µ—Ä–∏–¥–∏..."

# --- –ö–æ–ø—ñ—é—î–º–æ —Ñ–∞–π–ª –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π ---
COPY requirements.txt ./

# --- –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ Python-–∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ ---
RUN pip install --no-cache-dir -r requirements.txt

# --- –°—Ç–≤–æ—Ä—é—î–º–æ –∫–∞—Ç–∞–ª–æ–≥ –¥–ª—è –µ—Ñ–µ–º–µ—Ä–∏–¥ ---
RUN mkdir -p /data/ephe

# --- –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –µ—Ñ–µ–º–µ—Ä–∏–¥ swisseph ---
RUN git clone --depth 1 https://github.com/aloistr/swisseph.git /tmp/swisseph && \
    cp -r /tmp/swisseph/ephe/* /data/ephe/ && \
    rm -rf /tmp/swisseph

# --- –ö–æ–ø—ñ—é—î–º–æ –≤–µ—Å—å –∫–æ–¥ –ø—Ä–æ—î–∫—Ç—É ---
COPY . .

# --- –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –≥–æ—Ç–æ–≤–Ω—ñ—Å—Ç—å ---
RUN echo "‚ú® –ì–æ—Ç–æ–≤–æ! –ê—Å—Ç—Ä–æ–ª–æ–≥—ñ—á–Ω–∏–π —Å–µ—Ä–≤–µ—Ä —Å—Ç–∞—Ä—Ç—É—î‚Ä¶"

# --- –ó–∞–¥–∞—î–º–æ –ø–æ—Ä—Ç ---
ENV PORT=8080

# --- –ö–æ–º–∞–Ω–¥–∞ –∑–∞–ø—É—Å–∫—É ---
CMD ["gunicorn", "-b", "0.0.0.0:8080", "app:app"]